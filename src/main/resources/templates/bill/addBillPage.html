<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>新增帳單</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
</head>
<body>
    <div th:replace="~{layout/navbar}"></div>
    <div class="container">
        <h1 class="text-center">新增帳單</h1>
        <form method="post" th:action="@{/bill/addPost}" th:object="${bill}" class="form-horizontal" id="billForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="name">名稱:</label>
                <input type="text" id="name" th:field="*{name}" class="form-control" required />
            </div>
            <br />
            <div class="form-group">
                <label for="amount">金額:</label>
                <input type="number" id="amount" step="0.01" th:field="*{amount}" class="form-control" oninput="splitAmount()" />
            </div>
            <br />
            <div class="form-group">
                <label for="description">描述:</label>
                <input type="text" id="description" th:field="*{description}" class="form-control" required />
            </div>
            <br />
            <div class="form-group">
                <label for="payer">先付錢的人:</label>
                <select id="payer" name="payerId" class="form-control" required>
                    <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.nickname}"></option>
                </select>
            </div>
            <br />
            <div class="form-group">
                <label for="isManual">分配方式:</label>
                <select id="isManual" name="isManual" class="form-control" onchange="toggleManualAmount()">
                    <option value="false">平均分配</option>
                    <option value="true">手動指定</option>
                </select>
            </div>
            <br />
            <div class="form-group">
                <label for="participants">參與者:</label>
                <div th:each="user : ${users}">
                    <input type="checkbox" name="participantIds" th:value="${user.id}" onchange="splitAmount()" />
                    <span th:text="${user.nickname}"></span>
                    <br />
                    <label for="amounts">金額:</label>
                    <input type="number" step="0.01" name="amounts" class="participant-amount" readonly />
                </div>
            </div>
            <br />
            <div class="form-group">
                <label for="image">上傳圖片:</label>
                <input type="file" id="image" name="image" class="form-control" />
            </div>
            <br />
            <div class="form-group text-center">
                <input type="submit" value="送出" class="btn btn-primary" />
                <button type="button" class="btn btn-secondary" onclick="goToListPage()">返回</button>
            </div>
        </form>
    </div>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
        function splitAmount() {
            const amount = parseFloat(document.getElementById('amount').value);
            const checkboxes = document.querySelectorAll('input[name="participantIds"]:checked');
            const participantCount = checkboxes.length;
            const isManual = document.getElementById('isManual').value === 'true';

            if (!isManual && participantCount > 0) {
                const perPersonAmount = amount / participantCount || 0;

                const amountInputs = document.querySelectorAll('.participant-amount');
                amountInputs.forEach(input => {
                    input.value = '';
                });

                checkboxes.forEach(checkbox => {
                    const amountInput = checkbox.parentElement.querySelector('.participant-amount');
                    amountInput.value = perPersonAmount.toFixed(2);
                });
            }
        }

        function toggleManualAmount() {
            const isManual = document.getElementById('isManual').value === 'true';
            const amountInputs = document.querySelectorAll('.participant-amount');
            const amountField = document.getElementById('amount');
            amountInputs.forEach(input => {
                input.readOnly = !isManual;
                if (!isManual) {
                    splitAmount();
                } else {
                    input.value = '';
                }
            });

            // 禁用或啟用金額欄位
            amountField.required = !isManual;
            if (isManual) {
                amountField.value = '';
            }
        }

        function goToListPage() {
            window.location.href = '/bill/list';
        }

        // 初始化時計算每個參與者應分攤的金額
        document.addEventListener('DOMContentLoaded', splitAmount);
    </script>
</body>
</html>
